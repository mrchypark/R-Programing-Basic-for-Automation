---
title: "업무 자동화를 위한 R 더하기"
author: "박찬엽"
output:
  xaringan::moon_reader:
    seal: false
    css: ["default", "ninjutsu", "custom.css"]
    lib_dir: libs
    includes:
      in_header: google_analytics.html
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '4:3'
---
layout: true

background-image: url(https://user-images.githubusercontent.com/6179259/60290723-50002480-9954-11e9-96fe-3fbd4d7d11d9.png)
background-size: cover

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

---

class: center, middle, title-slide

## 업무자동화를 위한 R 더하기

### <https://mrchypark.github.io/R-Programing-Basic-for-Automation/>

#### [[의견 및 오류 신고]](https://github.com/mrchypark/R-Programing-Basic-for-Automation/issues)

### 박찬엽

### .small[2019년 6월 28일]

---

## 목차

1. 패키지 설치 방법 2 [remotes][remotes]
    - 특정 패키지의 함수를 지정 `::`
1. 데이터의 form 변환 [tidyr][tidyr]
1. 연장을 더 챙겨드림 1 [janitor][janitor]
1. 글자를 자유롭게 다루는 [stringr][stringr]
    - 글자 패턴 [rverbalexpressions][rverbalexpressions]
1. 날짜시간 자료형 [lubridate][lubridate]
1. 프로그래밍 흐름 처리 if, for
1. 예쁜 표 만들기 [gt][gt]
    - 신호등 만들기 [fontawesome][fontawesome]
1. 연장을 더 챙겨드림 2 [crosstalk][crosstalk] 

---
## 패키지 설치 방법 2 [remotes][remotes]

`remotes` 패키지는 `cran`이 아닌 곳에서 제공하는 패키지를 설치하는 함수를 제공

```{r eval=F}
## 패키지 설치 방법 1
install.packages("remotes")

## 패키지내 함수를 사용하기 위해 불러옴
library(remotes)

## 패키지 설치 방법 2
install_github("https://github.com/rstudio/fontawesome")
install_github("https://github.com/rstudio/gt")
```

---

## 패키지 설치 방법 2 [remotes][remotes]

패키지를 제공하는 가장 유명한 장소 [github][github]

![](https://user-images.githubusercontent.com/6179259/60295474-c013a800-995e-11e9-8827-f13d356ec04a.png)

---

## 패키지 설치 방법 2 [remotes][remotes]

패키지의 github 주소를 바로 사용하면 설치 진행

```{r eval=F}
install_github("https://github.com/rstudio/gt")
```

![](https://user-images.githubusercontent.com/6179259/60295635-24366c00-995f-11e9-9211-22c69ba240a3.png)

---

## 패키지 설치 방법 2 [remotes][remotes]

대부분 설명서에 설치하는 함수를 안내함.

![](https://user-images.githubusercontent.com/6179259/60295733-68c20780-995f-11e9-8a38-b5cb06e16fb9.png)

---

## 특정 패키지의 함수를 지정 `::`

`패키지이름::함수이름()` 으로 작성하면 어느 패키지의 함수인지 알 수 있음.

```{r eval=F}
install_github("https://github.com/rstudio/gt")
remotes::install_github("https://github.com/rstudio/gt")
```

---

## 특정 패키지의 함수를 지정 `::`

dplyr 패키지의 경우 많은 함수 이름이 다른 패키지와 겹침 

```{r eval=F}
library(dplyr)
```

```
#> 다음의 패키지를 부착합니다: ‘dplyr’
#> 
#> The following objects are masked from ‘package:stats’:
#> 
#>     filter, lag
#> 
#> The following object is masked from ‘package:testthat’:
#> 
#>     matches
#> 
#> The following objects are masked from ‘package:base’:
#> 
#>     intersect, setdiff, setequal, union
```
---

## 특정 패키지의 함수를 지정 `::`

혹시 `filter()` 함수가 문제가 생기면, 아래 처럼 해보세요.

```{r eval=F}
## dplyr 내의 모든 함수를 바로 사용하기 위해서 불러옴
library(dplyr)

## library로 패키지를 불러왔기 때문에
## 패키지내의 함수를 바로 사용할 수 있음
filter()

## 같은 이름을 가진 함수들이 있을 때는
## 이렇게 특정 패키지내의 함수를 사용하라고 작성할 수 있음
dplyr::filter()
```

---

## 데이터의 form 변환 [tidyr][tidyr]

```{r eval=F}
install.packages("tidyr")
```

`gather()` 함수와 `spread()` 함수를 제공    

<img src=https://user-images.githubusercontent.com/6179259/60299141-fa814300-9966-11e9-9f9f-d0f2bae656dc.png width=100%>

---
.pull-left[
### wide form
1. 사람이 눈으로 보기 좋은 모양
1. 2개 변수에 대한 값만 확인 가능
1. dashboard 형이라고도 하며 조인 등 연산이 어려움
]
.pull-right[
### long form
1. 컴퓨터가 계산하기 좋은 모양
1. tidy data의 요건을 충족
1. ggplot2 등 패키지 대부분의 입력 형태
]

![](https://user-images.githubusercontent.com/6179259/60298919-8181eb80-9966-11e9-944f-49231169f2bc.png)

---

## wide to long

gather() 함수는 미래의 key 이름과 value 이름을 받아서 wide form 데이터를 long form으로 바꿈

![](https://user-images.githubusercontent.com/6179259/60299951-dde60a80-9968-11e9-80e3-1a6a14e91412.png)

---

## wide to long

예시 데이터 만들기

```{r}
library(dplyr)

juniors_untidy <- tribble(
  ~ "baker", ~"cinnamon_1", ~"cardamom_2", ~"nutmeg_3",
  "Emma", 1L,   0L, 1L,
  "Harry", 1L,   1L, 1L,
  "Ruby", 1L,   0L, 1L,
  "Zainab", 0L, NA, 0L
)
juniors_untidy
```

---

## wide to long

key 컬럼 이름과 value 컬럼 이름을 정하고, long으로 바꿀 wide한 부분의 컬럼을 선택

```{r}
juniors_untidy %>% 
  gather(key = "spice",      # key  이름은 spice 로 하겠음
         value = "correct",  # value 이름은 correct로 하겠음
         cinnamon_1:nutmeg_3)# 이 컬럼들을 사용하겠음
```
---
## wide to long

![](https://github.com/apreshill/teachthat/blob/master/gather/gather.gif?raw=true)

---

## 실습용 패키지 설치

실습을 위해 사용할 [tqk][tqk] 패키지는 한국 주식 데이터를 가져옵니다.

```{r eval=F}
## remotes 패키지가 없다면 설치해주세요.
install.packages("remotes")
remotes::install_github("mrchypark/tqk")
```

---

## [tqk][tqk] 패키지 사용법

```{r eval=F}
library(tqk)
library(dplyr)
library(stringr)

# 주식종목 코드를 가져옵니다.
code_get() %>% 
  # 그 중에 현대자동차를 찾습니다.
  filter(str_detect(name, "현대자동차")) %>% 
  # code 만 선택합니다.
  select(code) %>% 
  # code에 해당하는 주식의 데이터를 가져옵니다.
  # 날짜의 범위를 지정할 수 있습니다.
  tqk_get(from = "2019-01-01", to = "2019-02-28") %>% 
  # 데이터에 현대자동차 주식이라는 것을 추가합니다.
  mutate(comp = "현대자동차") -> 
  hdcm
hdcm
```

---

## [tqk][tqk] 패키지 사용법

```{r cache=T, echo=F}
library(tqk)
library(dplyr)
library(stringr)

code_get() %>% 
  filter(str_detect(name, "현대자동차")) %>% 
  select(code) %>% 
  tqk_get(from = "2018-01-01", to = "2018-12-31") %>% 
  mutate(comp = "현대자동차") -> 
  hdcm
hdcm
```

---

## 연습문제 

- 앞서 만든 `hdcm` 데이터는 long form 인가요 wide form 인가요?

- `hdcm` 데이터를 `gather()` 함수를 이용해서 아래와 같이 long form 으로 바꾸어 보세요.

```{r echo=F}
hdcm %>% 
  gather(key = "type", value = "price", -date, -comp)
```

---

## 연습문제 

- 앞서 long form 으로 바꾼 데이터를 `hdcm_long`에 assign 하세요.
- `hdcm_long` 에서 `type` 이 "volume"인 것은 제외해주세요.

---

## long to wide

spead() 함수는 wide form 데이터에서 key column과 value column을 받아서  long form으로 바꿈

![](https://user-images.githubusercontent.com/6179259/60301034-5c43ac00-996b-11e9-95e8-cb2468192f24.png)

---

## long to wide

예시 데이터 만들기
.pull-left[
```{r}
library(dplyr)

juniors_about <- tribble(
  ~ "baker", ~"age",
  ~"outcome",~"spices",
  "Emma", 11L, "finalist", 2L, 
  "Harry", 10L, "winner", 3L, 
  "Ruby", 11L, "finalist", 2L, 
  "Zainab", 10L, "finalist", 0L
) %>% 
  gather(key = "var_name",
         value = "var_value",
         -baker)
```
]
.pull-right[
```{r echo=F}
juniors_about
```
]
---

## long to wide

key 컬럼 이름과 value 컬럼 이름을 정하고, long으로 바꿀 wide한 부분의 컬럼을 선택

```{r}
juniors_about %>% 
  spread(var_name, var_value)
```

---
## long to wide

![](https://github.com/apreshill/teachthat/blob/master/spread/spread.gif?raw=true)

---

## 연습문제 

`hdcm_md` 데이터를 아래 코드로 만들어 주세요.
.pull-left[
```{r}
library(lubridate)
hdcm %>% 
  mutate(
    month = month(date),
    day = day(date)
  ) %>% 
  select(
    comp, 
    month, 
    day, 
    close
  ) %>% 
  group_by(month) %>% 
  summarise(
    comp = "현대자동차",
    mclose = mean(close)
    )->
  hdcm_md
```
]
.pull-right[
```{r echo=F}
hdcm_md
```
]

---

## 연습문제 

1. `hdcm_md` 데이터를 아래와 같이 월 컬럼을 만들어 주세요.

```{r echo=F}
hdcm_md %>% 
  spread(month, mclose)
```

---

## 연장을 더 챙겨드림 1 [janitor][janitor]

![](https://user-images.githubusercontent.com/6179259/60302194-32d84f80-996e-11e9-8909-5482332b7f14.png)

---

## 글자를 자유롭게 다루는 [stringr][stringr]

```{r eval=F}
install.packages("stringr")
```

![](https://user-images.githubusercontent.com/6179259/60305497-a7fc5280-9977-11e9-823e-4afb4605d6f8.png)

---

## 필요없는 공백 제거

```{r}
library(stringr)
str_squish(" 안녕  하세요 \r\n\t") 
```

---

## 실습 데이터 설치

```{r eval=F}
remotes::install_github("mrchypark/krwifi")
```
```{r}
library(krwifi)
wifi
```

---

## mutate() 함수와 함께 사용하기

```{r}
wifi %>% 
  distinct(소재지도로명주소) %>% 
  slice(1:10) %>% 
  mutate(len = str_length(소재지도로명주소),
         gun_count = str_count(소재지도로명주소, "군")) 

```

---

## mutate() 함수와 함께 사용하기

```{r}
wifi %>% 
  distinct(설치시군구명) %>% 
  slice(1:10) %>% 
  mutate(repla = str_replace(설치시군구명, "군", "도로시"),
         extra = str_extract(설치시군구명, "주시"))
```

---

## mutate() 함수와 함께 사용하기

```{r}
wifi %>% 
  distinct(설치시군구명) %>% 
  slice(1:10) %>% 
  mutate(
    start = str_locate(설치시군구명, "구|군")[,1],
    end = str_locate(설치시군구명, "구|군")[,2]
  )
```

---

## mutate() 함수와 함께 사용하기

```{r}
wifi %>% 
  distinct(설치시군구명) %>% 
  slice(1:10) %>%
  mutate(remove = str_remove(설치시군구명, "구|군|시"),
         if_remove = if_else( str_length(설치시군구명) == 2,
                    설치시군구명, str_remove(설치시군구명, "구|군|시")))
```

---

## filter()함수와 함께 사용하기

```{r}
wifi %>% 
  filter(str_detect(소재지도로명주소, "군"))
```

---

## filter()함수와 함께 사용하기

```{r}
wifi %>% 
  filter(str_starts(설치장소상세 , "민원")) %>% 
  distinct(설치장소상세)
```

---

## filter()함수와 함께 사용하기

```{r}
wifi %>% 
  filter(str_starts(설치장소상세 , "민원")) %>% 
  count(설치장소상세, sort = T)
```

---

## 정규표현식이란

글자를 규칙이나 패턴으로 표현하는 문법 규칙의 일종

R에서 사용할 때는 `\` 의 사용이 조금 달라서 바로 사용하기 매우 어려움

```
/^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.
[a-zA-Z]{2,3}$
```

참고자료 : <http://www.nextree.co.kr/p4327/>

---

## 글자 패턴 [rverbalexpressions][rverbalexpressions]

정규표현식을 함수로 제공

![](https://user-images.githubusercontent.com/6179259/60304627-f6f4b880-9974-11e9-8494-24ccc2cd8f38.png)

---

## 날짜시간 자료형 [lubridate][lubridate]

```{r eval=F}
install.packages("lubridate")
```

![](https://user-images.githubusercontent.com/6179259/60305891-25749280-9979-11e9-81e4-25c9c3d8f805.png)

---

## 글자를 날짜시간 자료형으로

---

## 날짜시간 자료형에서 필요한 데이터 얻기

---

## 시간 자료형 [hms][hms]

```{r eval=F}
install.packages("hms")
```

![](https://user-images.githubusercontent.com/6179259/60306118-fb6fa000-9979-11e9-8591-76e242e9288f.png)


---

## 프로그래밍 흐름 처리 .small[(if, for)]


---

## 예쁜 표 만들기 [gt][gt]

![](https://user-images.githubusercontent.com/6179259/60302611-35877480-996f-11e9-823c-f04b5e30fe05.png)

---

## 예쁜 표 만들기 [gt][gt]

`gt()`를 이용해 출력 이후 `%>%` 로 연결해서 출력물 설정을 추가

```{r}
library(gt)
iris %>% 
  head() %>% 
  gt()
```

---

## 신호등 만들기 

[fontawesome][fontawesome] 패키지는 이모티콘을 사용할 수 있게 해줌
 
```{r message=F, echo=F}
library(stringr)
iris %>% head(9) %>% gt::gt() %>% 
    text_transform(
    locations = cells_data(
      columns = "Sepal.Length",
      rows = Sepal.Length > 5),
    fn = function(x) str_c(x," ", fontawesome::fa("circle", fill="green"))
  ) %>% 
      text_transform(
    locations = cells_data(
      columns = "Sepal.Length",
      rows = Sepal.Length < 5),
    fn = function(x) str_c(x, " ", fontawesome::fa("circle", fill="red"))
  ) %>% 
      text_transform(
    locations = cells_data(
      columns = "Sepal.Length",
      rows = Sepal.Length == 5),
    fn = function(x) str_c(x, " ", fontawesome::fa("circle", fill="yellow"))
  )
  
```

---

## [fontawesome][fontawesome] 패키지 설치

```{r eval=F}
remotes::install_github("rstudio/fontawesome")
```

## 사용법

[fontawesome 사이트][fontawesome 사이트] 에서 아이콘 이름을 찾는다.
[css 색][css 색]으로 채울 색을 지정한다. HEX도 사용가능. 이름의 대소문자를 구분하지 않음.

```{r}
fa("r-project", fill = "SteelBlue")
fa("r-project", fill = "#4682B4")
```

---

## 함수 만들기

`function()`로 만듬    
`()` 괄호에는 입력으로 받을 값을 대표 이름을 작성함     
`{}` 중괄호에는 괄호로 받은 대표 이름을 사용해서 코드를 작성하여 결과를 만듬    
`return()` 함수는 `{}` 중괄호 안에서 최종 함수의 결과를 결정함 하나의 객체만 가능    
`return()` 함수는 생략할 수 있음

.pull-left[
```{r}
plus <- function(a, b){
  tem <- a + b
  return(tem)
}
plus(3, 5)
```
]
.pull-right[
```{r}
plus_min <- function(a, b){
  tem <- a + b
  tem
}
plus_min(3, 5)
```
```
]
---

## 신호등 만들기

```{r eval=F}
library(stringr)
library(gt)
library(fontawesome)
tr_light_green <- function(x) str_c(x, fa("circle", fill="green")
tr_light_red <- function(x) str_c(x, fa("circle", fill="red")
tr_light_yellow <- function(x) str_c(x, fa("circle", fill="yellow")
iris %>% head(10) %>% gt() %>% 
  text_transform(
    locations = cells_data(
      columns = "Sepal.Length", rows = Sepal.Length > 5),
    fn = tr_light_green )
  ) %>% 
  text_transform(
    locations = cells_data(
      columns = "Sepal.Length", rows = Sepal.Length < 5),
    fn = tr_light_red)
  ) %>% 
  text_transform(
    locations = cells_data(
      columns = "Sepal.Length", rows = Sepal.Length == 5),
    fn = tr_light_yellow)
  )
  
```

---

## 연장을 더 챙겨드림 2 [crosstalk][crosstalk]

![](https://user-images.githubusercontent.com/6179259/60302256-661ade80-996e-11e9-85f3-fff17311b310.png)

---

class: center, middle, title-slide

## 감사합니다.


[gt]: https://gt.rstudio.com/
[lubridate]: https://lubridate.tidyverse.org/index.html
[tidyr]: https://tidyr.tidyverse.org/
[stringr]: https://stringr.tidyverse.org/
[rverbalexpressions]: https://rverbalexpressions.netlify.com/index.html
[janitor]: http://sfirke.github.io/janitor/
[crosstalk]: https://rstudio.github.io/crosstalk/using.html
[remotes]: https://remotes.r-lib.org/
[fontawesome]: https://github.com/rstudio/fontawesome
[github]: https://github.com/
[tqk]: https://mrchypark.github.io/tqk/
[fontawesome 사이트]: https://fontawesome.com/
[css 색]: https://www.w3schools.com/cssref/css_colors.asp
[hms]: https://hms.tidyverse.org/
